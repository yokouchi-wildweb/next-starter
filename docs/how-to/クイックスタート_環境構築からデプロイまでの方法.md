# クイックスタート: 環境構築からデプロイまでの方法

本ドキュメントでは、リポジトリを取得してローカル開発を始めるところから、Firebase へデプロイするまでの一連の手順をまとめています。前半はローカル環境構築、後半は本番デプロイの準備と実行手順です。

---

## 1. 事前準備

- Node.js 18 以上 (Next.js 15 系の動作要件)
- npm 10 以上
- Firebase CLI (`npm install -g firebase-tools`)
- Git / GitHub へのアクセス権
- Neon 等の PostgreSQL 接続情報（Drizzle で利用）

開発用と本番用に `.env.development` と `.env.production` を作成し、後述の値を設定します。

---

## 2. リポジトリの取得と初期設定

```bash
# リポジトリを clone
$ git clone <REPOSITORY_URL>
$ cd next-starter

# 依存関係をインストール
$ npm install

# Drizzle のマイグレーションファイル生成（必要に応じて）
$ npx drizzle-kit generate

# PostgreSQL にスキーマを適用（Neon など外部 DB を使用する場合）
$ APP_ENV=.env.development npx drizzle-kit push
```

> `APP_ENV` を `.env.production` などに切り替えると、該当ファイルの `DATABASE_URL` が参照されます。未指定の場合は既定の `.env` が読み込まれます。`npx drizzle-kit ...` は `npm run db:generate` / `npm run db:push` のラッパーですが、初回セットアップでは直接 `npx` 経由で実行して構いません。

---

## 3. バックエンドサービスの設定

Firebase や Neon などバックエンドサービスの初期設定を先に済ませておくと、以降の環境変数設定やデプロイがスムーズになります。具体的には以下の作業を行います。

- Neon から `DATABASE_URL` を取得し、開発・本番環境で利用する接続情報を整理する
- Firebase で Web アプリ登録、SDK 設定値、サービスアカウント鍵、Storage / Firestore / Authentication の各初期設定を完了する
- Firebase App Hosting のセットアップや独自ドメイン利用時の DNS 設定方針を確認しておく

詳細な手順は [Neon Firebase など各種バックエンドサービスの設定方法](./Neon_Firebaseなど各種バックエンドサービスの設定方法.md) を参照してください。ここまで完了していると、次節で扱う `.env.*` や `apphosting.yaml` に正しい値を記入できます。

---

## 4. 環境変数ファイルの設定

### 4.1 `.env.development`

ローカル開発用。`.env.example` をベースに以下のように定義します。

```dotenv
# 認証セッション用 JWT シークレット（任意の文字列に変更）
AUTH_JWT_SECRET=your-local-secret

# ログレベル。数値が高いほど詳細な出力だが情報漏洩に注意
NEXT_PUBLIC_LOG_LEVEL=3

# Firebase (ブラウザ SDK 共通設定)
NEXT_PUBLIC_FIREBASE_API_KEY=xxxx
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=xxxx.web.app
NEXT_PUBLIC_FIREBASE_PROJECT_ID=xxxx
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=xxxx.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=xxxx
NEXT_PUBLIC_FIREBASE_APP_ID=1:xxxx:web:xxxx

# Drizzle / Neon 等の DB 接続文字列
DATABASE_URL=postgresql://<user>:<password>@<host>/<database>

# Firebase Admin 用サービスアカウント JSON
MY_SERVICE_ACCOUNT_KEY='{"type":"service_account", ... }'
```

ポイント:

- `DATABASE_URL` は `drizzle.config.ts` から参照されます。マイグレーション実行時に `APP_ENV` を指定すると、ここで説明した `.env.development` や `.env.production` を状況に応じて読み分けられます。
- `MY_SERVICE_ACCOUNT_KEY` は Firebase Admin SDK 初期化に利用します。改行は `\n` にエスケープしてください。

### 4.2 `.env.production`

本番ビルドで参照される値を定義します。基本的に `.env.development` と同じキーを、本番用の資格情報で上書きします。

```dotenv
AUTH_JWT_SECRET=your-production-secret
NEXT_PUBLIC_LOG_LEVEL=0 # 本番では0を推奨
NEXT_PUBLIC_FIREBASE_API_KEY=xxxx
NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN=xxxx.web.app
NEXT_PUBLIC_FIREBASE_PROJECT_ID=xxxx
NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET=xxxx.appspot.com
NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID=xxxx
NEXT_PUBLIC_FIREBASE_APP_ID=1:xxxx:web:xxxx
DATABASE_URL=postgresql://<user>:<password>@<host>/<database>
MY_SERVICE_ACCOUNT_KEY='{"type":"service_account", ... }'
```

### 4.3 `apphosting.yaml`

Firebase App Hosting（Cloud Run 連携）の設定ファイルです。`apphosting.sample.yaml` をコピーし、必要な値を更新してください。


```bash
$ cp apphosting.sample.yaml apphosting.yaml
```

> firebase init コマンドで設定を行う際に自動生成される場合もあります。

主な設定項目:

```yaml
env:
  - variable: APP_ENV
    value: production
    availability:
      - BUILD
      - RUNTIME
```

- `runConfig.minInstances`: 最低起動インスタンス数。0 でスケールインを許可。
- `env`: ビルド時とランタイム時に Next.js へ渡す環境変数。`.env.production` と同様のキーを設定します。
  - `availability` に `BUILD` と `RUNTIME` を指定しておくと両方のフェーズで利用可能になります。
  - `MY_SERVICE_ACCOUNT_KEY` のような JSON を埋め込む場合はパイプ (`|`) を使って複数行リテラルを記述します。



---

## 5. ローカル開発サーバーの起動

環境変数を設定したら、開発サーバーを起動します。

```bash
# 環境ごとに読み込む .env を切り替える場合は cross-env 等を利用
# ここでは .env.development をルートに配置し Next.js に読み込ませます
$ npm run dev
```

`http://localhost:3000` へアクセスして、アプリが起動することを確認します。

---

## 6. 本番ビルドの実行

デプロイ前に本番ビルドをローカルで確認します。

```bash
# .env.production を参照するように環境変数を読み込む（シェルに応じて適宜設定）
$ cp .env.production .env.local # 例: Next.js が読み込むファイル名にコピー
$ npm run build
```

ビルドが成功したら `npm run start` でローカル検証も可能です。

---

## 7. Firebase へのデプロイ準備

1. **ログイン**: Firebase CLI で Google アカウントにログインします。
   ```bash
   $ firebase login
   ```
2. **初期化**: プロジェクトに Firebase 設定を適用していない場合は `firebase init` を実行し、Hosting / App Hosting / Firestore / Storage など必要なサービスを有効化します。
   ```bash
   $ firebase init
   ```
   - 既存プロジェクトを選択し、`firebase.json` と `.firebaserc` の内容が正しいことを確認してください。
3. **プロジェクト確認**: デプロイ先のエイリアスが `.firebaserc` に設定されているか確認します。`firebase use` コマンドで現在のターゲットを確認・変更できます。
   ```bash
   $ firebase use <alias>
   ```

---

## 8. Firebase へデプロイ

本番ビルドが完了し、Firebase CLI の準備が整ったら以下を実行します。

```bash
# 必要に応じて最新ビルドを生成
$ npm run build

# Next.js App Hosting へデプロイ
$ firebase deploy
```

`firebase deploy` は `firebase.json` の設定に従って Hosting / App Hosting / Firestore / Storage など関連リソースをまとめてデプロイします。個別にデプロイしたい場合は `--only hosting`, `--only apphosting` などのオプションを利用してください。

---

## 9. トラブルシューティング

- **環境変数が反映されない**: Firebase App Hosting では `apphosting.yaml` に記述した変数のみ利用されます。`.env.production` の値を忘れずに反映してください。
- **Drizzle の接続エラー**: `DATABASE_URL` の権限やホワイトリストを確認し、マイグレーション実行環境からアクセスできるようにします。
- **Firebase CLI の認証期限切れ**: `firebase login --reauth` を実行して再ログインします。

---

以上で、ローカル開発から Firebase へのデプロイまでの基本的な流れは完了です。各工程で不明点があれば、関連ドキュメント（`docs/how-to` 配下や `docs/!must-read`）も参照してください。
