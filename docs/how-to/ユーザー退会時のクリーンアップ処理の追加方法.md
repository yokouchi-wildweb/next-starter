# ユーザー退会時のクリーンアップ処理の追加方法

## ユーザークリーンアップレジストリ

ユーザーの退会・ソフトデリート時に実行されるリソースクリーンナップ処理を管理する。

### 概要

```
userCleanupRegistry.ts    ← ハンドラの登録
executeCleanup.ts         ← 実行エンジン（src/features/core/user/services/server/）
```

退会（ユーザー自身）とソフトデリート（管理者）の両方で `executeCleanup` が呼ばれ、レジストリに登録されたハンドラが順次実行される。

> ステータス変更（`withdrawn` への更新）はレジストリの責務外。各呼び出し元（`withdraw.ts` / `softDelete.ts`）が自前で行う。

### ハンドラの種類

| 種類 | 失敗時の挙動 | 用途 |
|------|-------------|------|
| `requiredHandlers` | トランザクション全体をロールバック | データ整合性が必須な処理 |
| `optionalHandlers` | ログ記録して続行 | ベストエフォートな処理 |

### 現在の登録ハンドラ（ベーステンプレート）

```
required:
  - clearWalletBalance     … ウォレット残高を0にクリア + 履歴記録

optional:
  - cancelPendingPurchaseRequests  … 未処理の購入リクエストをキャンセル
```

---

### クリーンアップハンドラの追加方法

下流プロジェクトで独自のクリーンアップ処理を追加する手順。

#### 1. ハンドラ関数を作成

`UserCleanupHandler` 型に従い、対象ドメインの `services/server/` 配下に作成する。

```typescript
// src/features/<domain>/services/server/cleanupOnWithdraw.ts

import type { DbTransaction } from "@/lib/crud/drizzle/types";

export async function cleanupOnWithdraw(userId: string, tx: DbTransaction): Promise<void> {
  // userId に紐づくリソースのクリーンナップ処理
  // tx を使ってDB操作を行う（トランザクション内で実行される）
}
```

**注意点:**
- 引数は `(userId: string, tx: DbTransaction)` 固定
- 必ず渡された `tx` を使ってDB操作を行うこと（トランザクションの一貫性を保つため）
- 関数内で独自にトランザクションを開始しないこと

#### 2. レジストリに登録

`src/registry/userCleanupRegistry.ts` の適切な配列にハンドラを追加する。

```typescript
import { cleanupOnWithdraw } from "@/features/<domain>/services/server/cleanupOnWithdraw";

// データ整合性が必須 → requiredHandlers
export const requiredHandlers: UserCleanupHandler[] = [
  clearWalletBalance,
  cleanupOnWithdraw,  // 追加
];

// 失敗しても許容できる → optionalHandlers
export const optionalHandlers: UserCleanupHandler[] = [
  cancelPendingPurchaseRequests,
  cleanupOnWithdraw,  // または、こちらに追加
];
```

#### 3. required と optional の選択基準

| 基準 | required | optional |
|------|----------|----------|
| 失敗時にデータ不整合が起きるか | はい → required | いいえ → optional |
| 例: 残高・ポイントのクリア | required | - |
| 例: 通知の送信、外部APIへの通知 | - | optional |
| 例: 未処理リクエストのキャンセル | ケースバイケース | ケースバイケース |

迷った場合は `required` を選択し、データ整合性を優先する。

### 呼び出しフロー

```
■ ユーザー退会（withdraw.ts）
  transaction:
    base.update(status: "withdrawn")
    executeCleanup(userId, tx)
      ├─ requiredHandlers（順次実行、失敗→ロールバック）
      └─ optionalHandlers（順次実行、失敗→ログ記録して続行）

■ 管理者ソフトデリート（softDelete.ts）
  transaction:
    base.remove()                  … deletedAt を設定
    setStatusWithdrawn(userId, tx) … status を withdrawn に変更
    executeCleanup(userId, tx)
      ├─ requiredHandlers
      └─ optionalHandlers
```
