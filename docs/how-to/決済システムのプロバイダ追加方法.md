# 決済システムのプロバイダ追加方法

新しい決済プロバイダ（Stripe, KOMOJU, PayPay等）を追加する手順を説明します。

## 概要

決済システムは以下の設計思想に基づいています：

- **プロバイダ抽象化**: `PaymentProvider` インターフェースにより、プロバイダ固有の実装を隠蔽
- **環境変数での切り替え**: `PAYMENT_PROVIDER` でプロバイダを切り替え可能
- **Webhook識別子リゾルバー**: プロバイダ固有のID体系に対応

---

## 1. プロバイダクラスの作成

### 1.1 ディレクトリ構造

```
src/features/core/purchaseRequest/services/server/payment/
├── index.ts                    # プロバイダファクトリ
├── dummyProvider.ts            # 開発用ダミー
└── <provider-name>/            # 新規プロバイダ
    ├── index.ts                # エクスポート
    ├── <provider>Provider.ts   # メイン実装
    └── errorMapping.ts         # エラーコードマッピング（任意）
```

### 1.2 PaymentProvider インターフェースの実装

`src/features/core/purchaseRequest/types/payment.ts` を参照し、以下のメソッドを実装：

```typescript
// src/features/core/purchaseRequest/services/server/payment/stripe/stripeProvider.ts

import type {
  PaymentProvider,
  CreatePaymentSessionParams,
  PaymentSession,
  PaymentResult,
  PaymentStatusResult,
} from "@/features/core/purchaseRequest/types/payment";

export class StripePaymentProvider implements PaymentProvider {
  readonly providerName = "stripe";

  /**
   * 決済セッションを作成
   * ユーザーをリダイレクトするURLを返す
   */
  async createSession(params: CreatePaymentSessionParams): Promise<PaymentSession> {
    // Stripe Checkout Session を作成
    const session = await stripe.checkout.sessions.create({
      mode: "payment",
      success_url: params.successUrl,
      cancel_url: params.cancelUrl,
      line_items: [{ price_data: { ... }, quantity: 1 }],
      metadata: { purchaseRequestId: params.purchaseRequestId },
    });

    return {
      sessionId: session.id,
      redirectUrl: session.url!,
      expiresAt: new Date(session.expires_at * 1000),
    };
  }

  /**
   * Webhookペイロードを検証・パース
   */
  async verifyWebhook(request: Request): Promise<PaymentResult> {
    const body = await request.text();
    const sig = request.headers.get("Stripe-Signature")!;

    const event = stripe.webhooks.constructEvent(body, sig, webhookSecret);

    if (event.type === "checkout.session.completed") {
      const session = event.data.object;
      return {
        success: true,
        sessionId: session.id,
        transactionId: session.payment_intent,
        paymentMethod: "credit_card",
        paidAt: new Date(),
        rawResponse: event,
      };
    }

    return {
      success: false,
      sessionId: "",
      errorCode: "UNKNOWN_EVENT",
      errorMessage: `Unknown event type: ${event.type}`,
    };
  }

  /**
   * Webhook署名を検証（オプション）
   */
  async verifyWebhookSignature(request: Request, signature: string): Promise<boolean> {
    // Stripeの場合、verifyWebhook内で検証するため常にtrueを返す
    return true;
  }

  /**
   * 決済ステータスを照会（オプション、ポーリング用）
   */
  async getPaymentStatus(sessionId: string): Promise<PaymentStatusResult> {
    const session = await stripe.checkout.sessions.retrieve(sessionId);

    return {
      status: session.payment_status === "paid" ? "completed" : "pending",
      sessionId,
      transactionId: session.payment_intent as string,
      paidAt: session.payment_status === "paid" ? new Date() : undefined,
    };
  }
}

export const stripePaymentProvider = new StripePaymentProvider();
```

### 1.3 エクスポート用 index.ts

```typescript
// src/features/core/purchaseRequest/services/server/payment/stripe/index.ts

export { stripePaymentProvider } from "./stripeProvider";
```

---

## 2. プロバイダファクトリへの登録

### 2.1 型定義の追加

```typescript
// src/features/core/purchaseRequest/services/server/payment/index.ts

export type PaymentProviderName = "dummy" | "komoju" | "fincode" | "stripe"; // ← 追加
```

### 2.2 ファクトリ関数への追加

```typescript
// src/features/core/purchaseRequest/services/server/payment/index.ts

import { stripePaymentProvider } from "./stripe";

export function getPaymentProvider(providerName: PaymentProviderName): PaymentProvider {
  switch (providerName) {
    case "dummy":
      return dummyPaymentProvider;
    case "fincode":
      return fincodePaymentProvider;
    case "stripe":                      // ← 追加
      return stripePaymentProvider;
    default:
      throw new Error(`Unknown payment provider: ${providerName}`);
  }
}
```

### 2.3 デフォルトプロバイダの設定

```typescript
export function getDefaultProviderName(): PaymentProviderName {
  const envProvider = process.env.PAYMENT_PROVIDER;
  if (envProvider === "stripe") return "stripe";  // ← 追加
  // ...
  return "dummy";
}
```

---

## 3. 決済設定への追加

```typescript
// src/config/app/payment.config.ts

export const paymentConfig = {
  providers: {
    // ... 既存プロバイダ
    stripe: {
      enabled: true,
      supportedMethods: ["credit_card"],
    },
  },

  webhook: {
    signatureHeaders: {
      // ... 既存設定
      stripe: "Stripe-Signature",  // ← Webhookの署名ヘッダー
    },
  },
};
```

---

## 4. Webhook識別子リゾルバーの追加（必要な場合）

プロバイダがWebhookで独自のID体系を使用する場合、リゾルバーを追加します。

### 4.1 リゾルバー関数の作成

```typescript
// src/features/core/purchaseRequest/services/server/wrappers/purchaseService.ts

/**
 * Stripe用リゾルバー
 * StripeはセッションIDをそのまま送信するため、通常は不要
 * 特殊なケースがある場合のみ実装
 */
async function resolveStripeIdentifier(
  identifier: string
): Promise<PurchaseRequest | null> {
  // Stripe固有のロジック（通常は不要）
  return null;
}
```

### 4.2 リゾルバーマップへの登録

```typescript
const webhookIdentifierResolvers: Partial<
  Record<PaymentProviderName, WebhookIdentifierResolver>
> = {
  fincode: resolveFincodeIdentifier,
  stripe: resolveStripeIdentifier,  // ← 追加（必要な場合のみ）
};
```

### リゾルバーが必要なケース

| プロバイダ | リゾルバー必要？ | 理由 |
|-----------|-----------------|------|
| Stripe | 不要 | セッションIDをそのまま送信 |
| Fincode | **必要** | order_id（UUID短縮形）を送信 |
| KOMOJU | 不要 | payment_idをそのまま送信 |
| PayPay | 要確認 | プロバイダの仕様による |

---

## 5. 環境変数の設定

```env
# .env.development / .env.production

# プロバイダ選択
PAYMENT_PROVIDER=stripe

# Stripe設定
STRIPE_SECRET_KEY=sk_test_xxx
STRIPE_PUBLISHABLE_KEY=pk_test_xxx
STRIPE_WEBHOOK_SECRET=whsec_xxx
```

---

## 6. Webhookエンドポイント

Webhookは既存のエンドポイントを使用します：

```
POST /api/webhook/payment?provider=stripe
```

プロバイダのダッシュボードで以下のURLを設定：
- 開発: `https://<ngrok-url>/api/webhook/payment?provider=stripe`
- 本番: `https://your-domain.com/api/webhook/payment?provider=stripe`

---

## 7. テスト

### 7.1 開発環境でのテスト

1. ngrokを起動: `ngrok http 3000`
2. プロバイダのダッシュボードでWebhook URLを設定
3. テスト決済を実行
4. ngrok Web Interface (`http://127.0.0.1:4040`) でWebhookを確認

### 7.2 Webhookのリプレイテスト

ngrokのReplayボタンを使用して、Webhookの冪等性を確認：
- 同じWebhookを複数回送信しても正常に処理される
- 既に完了した取引の再送で重複処理されない

---

## チェックリスト

新しいプロバイダを追加する際のチェックリスト：

- [ ] `PaymentProvider` インターフェースを実装
- [ ] `payment/index.ts` の `PaymentProviderName` 型に追加
- [ ] `getPaymentProvider` ファクトリに追加
- [ ] `getDefaultProviderName` に追加
- [ ] `payment.config.ts` に設定追加
- [ ] 環境変数を設定
- [ ] （必要な場合）Webhook識別子リゾルバーを追加
- [ ] ngrokでWebhookテスト
- [ ] 冪等性テスト（Replay）

---

## 関連ファイル

| ファイル | 役割 |
|---------|------|
| `types/payment.ts` | PaymentProviderインターフェース定義 |
| `payment/index.ts` | プロバイダファクトリ |
| `payment/<provider>/` | プロバイダ実装 |
| `wrappers/purchaseService.ts` | 購入フロー制御、リゾルバー、マイルストーン結果永続化 |
| `config/app/payment.config.ts` | 決済設定 |
| `app/api/webhook/payment/route.ts` | Webhookエンドポイント |
| `app/api/wallet/purchase/callback/route.ts` | POST→GETリダイレクト処理 |

---

## トラブルシューティング

### Webhookが届かない

1. ngrokが起動しているか確認
2. プロバイダのダッシュボードでURLが正しいか確認
3. 必要なイベントが有効になっているか確認

### 署名検証エラー（401）

1. 環境変数の署名シークレットが正しいか確認
2. `payment.config.ts` の `signatureHeaders` が正しいか確認

### セッションが見つからない

1. `payment_session_id` がDBに保存されているか確認
2. リゾルバーが正しく実装されているか確認
3. ステータスが `processing` または `completed` か確認
