# ドメインフィールド型定義の設計

domain.json およびプロフィールフィールドで使用する型定義の設計方針をまとめます。

---

## 型定義の場所

| 型 | 定義場所 | 用途 |
|----|----------|------|
| DomainFormInput | src/components/Form/DomainFieldRenderer/types.ts | フォーム入力種別 |
| DomainFieldType | 同上 | Neon DB データ型 |
| DomainJsonField | 同上 | domain.json Field 定義 |
| CoreProfileFieldTag | src/features/core/user/types/profileField.ts | コアタグ（システム保護） |
| ProfileFieldConfig | 同上 | ロール別プロフィールフィールド |
| RoleCategory | src/features/core/user/types/role.ts | ロールカテゴリ |
| RoleConfig | 同上 | ロール定義型 |
| ProfileFieldTag | src/config/app/roles.config.ts | 全タグ（コア + 追加） |

---

## DomainJsonField

domain.json の Field 定義と完全互換の型。

### 必須プロパティ
- `name`: フィールド名（snake_case）
- `label`: 表示ラベル
- `formInput`: 入力種別（DomainFormInput）

### オプショナルプロパティ
- `fieldType`: データ型（Drizzle スキーマ生成時は必須）
- `required`, `readonly`, `defaultValue`, `options`, `placeholder` 等

---

## ProfileFieldConfig

DomainJsonField を拡張したロール別プロフィール用の型。

```typescript
type ProfileFieldConfig<TTag extends string = string> = DomainJsonField & {
  fieldType: DomainFieldType;      // 必須に上書き
  tags: readonly TTag[];           // 用途タグ
  description?: string;            // 説明文
};
```

---

## ProfileFieldTag（用途タグ）

フィールドの表示箇所をタグで制御。

### コアタグ（システム保護、変更不可）

| タグ | 用途 | 定義場所 |
|------|------|----------|
| `admin` | 管理画面でのみ表示 | types/profileField.ts |
| `registration` | 本登録画面で表示 | 同上 |
| `mypage` | マイページで表示 | 同上 |

### 追加タグ（ユーザー拡張可能）

| タグ | 用途 | 定義場所 |
|------|------|----------|
| `notification` | 通知設定画面で表示 | roles.config.ts |
| (カスタム) | プロジェクト固有 | roles.config.ts |

### タグ拡張方法

```typescript
// src/config/app/roles.config.ts
export const ADDITIONAL_PROFILE_FIELD_TAGS = ["notification", "custom"] as const;
```

### 設定例

```typescript
// roles.config.ts
profileFields: [
  {
    name: "organization_name",
    tags: ["registration", "mypage"],  // 登録時とマイページで表示
    ...
  },
  {
    name: "is_approved",
    tags: ["admin"],                   // 管理画面のみ
    formInput: "hidden",               // フォームでは非表示
    ...
  },
]
```

### ヘルパー関数

| 関数 | 用途 |
|------|------|
| `getFieldsByTags(role, tags)` | 指定タグを持つフィールドを取得（汎用） |
| `getRegistrationFields(role)` | 登録画面用フィールド |
| `getMyPageFields(role)` | マイページ用フィールド |
| `getAdminFields(role)` | 管理画面用（hidden 除く全て） |

---

## ファイル構成

### システム基盤（変更禁止）
```
src/features/core/user/types/
  profileField.ts   ← CoreProfileFieldTag, ProfileFieldConfig
  role.ts           ← RoleCategory, RoleConfig, AdditionalRoleConfig
  index.ts          ← re-export
```

### ユーザー編集可能
```
src/config/app/
  roles.config.ts   ← ADDITIONAL_PROFILE_FIELD_TAGS, ADDITIONAL_ROLES
```

---

## 命名規則と変換

| コンテキスト | 規則 | 例 |
|-------------|------|-----|
| domain.json / ProfileFieldConfig | snake_case | organization_name |
| TypeScript フォームフィールド | camelCase | organizationName |

変換ヘルパー:
```typescript
const snakeToCamel = (str: string): string =>
  str.replace(/_([a-z])/g, (_, c) => c.toUpperCase());
```

---

## domain.json からの読み込み

JSON ファイルは TypeScript の型推論が効かないため、型キャストが必要。

```typescript
// domain.json インポート時
const fields = (domainConfig.fields ?? []) as DomainJsonField[];
```

---

## 関連ファイル

- src/components/Form/DomainFieldRenderer/ - フォームレンダリング
- src/features/core/user/types/ - プロフィール・ロール型定義（システム基盤）
- src/features/core/user/constants/role.ts - ヘルパー関数
- src/config/app/roles.config.ts - ロール・タグ設定（ユーザー編集）
- src/features/README.md - domain.json 仕様
