# ウォレット機能の設計と運用ガイド

複数種類のアプリ内リソース（通常ポイント、ボーナスポイント、コイン、ルビーなど）を共通の仕組みで管理するためのウォレット設計方針をまとめます。  
`wallet` / `wallet_history` の 2 テーブルを基盤とし、任意のリソースを `type` カラムで区別します。

---

## 1. ウォレット構造

| テーブル | 主なフィールド | 説明 |
| --- | --- | --- |
| **wallet** | `user_id` | ユーザー ID |
|  | `type` | `regular_point` / `bonus_point` / `temporary_point` / `coin` / `ruby` など、リソース名を識別する列挙。`user_id` と合わせてユニーク制約を張る |
|  | `balance` | 現在の残高 |
|  | `locked_balance` | 進行中リクエストで予約済みの残高。`balance - locked_balance` が即時に使える金額となる |
|  | `updated_at` | 最終更新 |

| テーブル | 主なフィールド | 説明 |
| --- | --- | --- |
| **wallet_history** | `id` | 履歴 ID |
|  | `user_id` | ユーザー |
|  | `type` | 更新対象のウォレット種別 |
|  | `change_method` | `INCREMENT` / `DECREMENT` / `SET` |
|  | `points_delta` | `INCREMENT/DECREMENT` では増減量、`SET` の場合は上書き後の絶対値 |
|  | `balance_before` / `balance_after` | 変動前後の残高 |
|  | `source_type` | `user_action` / `admin_action` / `system` などの区別 |
|  | `request_batch_id` | 連続処理の親 ID（単発なら `null`） |
|  | `reason` | 変化理由の短い説明 |
|  | `meta` | JSONB でリソース固有の付随情報を保持（例: `machineId`, `transactionId`） |
|  | `created_at` | 記録日時 |

---

## 2. ロックと残高の扱い

1. **残高チェック**: 利用可能残高 `available = balance - locked_balance` を算出し、操作に必要な額を満たすか判定する。
2. **予約 (lock)**: リクエスト単位で必要額 `reserve` を求め、`locked_balance += reserve` を行ってから処理を開始する。
3. **確定消費 (consume)**: バッチ処理中は各ステップで `locked_balance -= unit` と同額の `balance -= unit` をセットで行い、予約分を確定させる。
4. **失敗時の返却**: エラーで処理を中断する場合は、残っている予約分だけ `locked_balance` を戻す。`balance` は減らさないのでトランザクション整合性を保てる。

このルールにより、並列リクエストでも二重消費を防ぎ、予約／確定の状態遷移をわかりやすく管理できる。

---

## 3. リクエスト単位の管理

- 10 連 / 100 連など複数回実行する操作は、サーバーが `request_batch_id` を生成し、`wallet_history` と関連ドメイン（例: `gacha_play_history`）で同じ ID を共有する。
- UI は `request_batch_id` ごとにグループ化して表示できるため、100 連を 1 つのまとまりとして解釈できる。
- バッチジョブ（例: 有効期限切れのポイント返還）も `request_batch_id` を使えば追跡・再実行が容易になる。

---

## 4. メタ情報 (`meta`) の活用

- JSONB 形式で任意のキーを保存できる。ウォレットでは最低限として **ポイントを消費した対象の商品 ID**（`meta.productId`）や **紐づくガチャ / 注文 ID**（`meta.gachaId`, `meta.orderId` など）を格納し、履歴から直接関連エンティティをたどれるようにする。
- 管理者操作では `meta.adminId` に管理者 ID を保持し、`meta.operatorScreen` や `meta.notes` などで UI 由来の情報・問い合わせ番号を記録する（`operator_id` カラムは持たず、JSONB に一元化する）。
- その他任意のログ（例: `{ "machineId": "xxx", "machineName": "レアガチャ", "playCount": 10 }`）も必要に応じ追加できる。
- **インデックス運用**: 現状は小規模運用のためインデックスを保持せず、実際に検索・集計したいキーが固まった段階で `entities/drizzle.ts` に `CREATE INDEX` を定義し、`db:generate` → `db:push`（`drizzle-kit`）で適用する。`meta ->> 'productId'` など頻出キーには GIN インデックスを貼ることで高速化できる。

---

## 5. 多通貨対応の方針

- 新しいリソースは `type` に値を追加するだけで登録できる。例: `coin`, `ruby`, `event_token`。
- `wallet` を共通化することで CRUD・残高チェック・履歴記録の処理フローを全リソースで共有でき、テーブル増殖を避けられる。
- 期限付きリソース（`temporary_point` など）は別テーブルで期限情報を管理しつつ、還元や失効時に `wallet` / `wallet_history` を更新する。

---

## 6. 実装時のチェックリスト

1. 操作前に `available >= reserve` を確認してから `locked_balance` を更新しているか。
2. 失敗時に残りのロックを必ず解放しているか。
3. `wallet_history` に `type`, `request_batch_id`, `reason`, `meta.productId` / `meta.orderId` / `meta.adminId` など必要情報を忘れず記録しているか。
4. リクエスト単位で `request_batch_id` を共有し、表示や監査で活用できる状態か。
5. 新しいリソース種別を追加した際、`type` の enum を更新し、必要な初期残高を投入しているか。

ウォレットを共通インフラとして整備することで、ポイント以外のリソースを柔軟に追加しつつ、監査・履歴・残高管理を統一できます。

---

## 7. 既存コアドメインとの連携

- **ユーザー / 認証ドメインとの接続**: `wallet` / `wallet_history` の `user_id` は `core/user` が管理する ID を参照し、ログイン済みユーザーの残高取得や操作は `core/auth` による認証結果を前提に行う。管理者操作も `core/auth` の管理者 ID を `meta.adminId` として記録する。

---

## 8. 実装ファイルと役割一覧

| ドメイン/責務 | ファイル / ディレクトリ | 役割 |
| --- | --- | --- |
| wallet | `domain.json` | ウォレットドメインの生成設定。`type` / `balance` / `locked_balance` など基礎フィールドや生成対象カテゴリを定義する。 |
| wallet | `entities/*` | `drizzle.ts`（table 定義）、`schema.ts`（Zod）、`model.ts`（ドメインモデル）などウォレットエンティティ一式。Drizzle マイグレーションの基盤。 |
| wallet | `services/server/walletService.ts` | 残高更新・ロック処理・履歴書き込みなどサーバーサイドのビジネスロジック。`db.transaction` を介して `wallet` と `wallet_history` を一貫して更新する。 |
| wallet | `services/server/drizzleBase.ts` | 自動生成された CRUD ベースサービス。共通の create/list/update などを提供し、`walletService.ts` からラップして利用する。 |
| wallet | `services/server/wrappers/*` | `adjustBalance`, `reserveBalance`, `releaseReservation` など責務ごとに切り分けたモジュール。単一ファイルにロジックを詰め込まず、将来的な決済連携やジョブ処理に応じてファイル追加・差し替えができる構造を維持する。 |
| wallet | `services/client/walletClient.ts` | axios ベースのクライアント API。管理画面・ユーザー画面からウォレット操作や残高取得を呼び出す窓口。 |
| wallet | `hooks/*` | `useWallet`, `useWalletList`, `useAdjustWallet`（追加予定）など CRUD/SWR フック。UI 層からクライアントサービスを呼ぶ。 |
| wallet | `constants/field.ts` / `types/field.ts` | `WalletType` など Enum / 型定義。フォームやサービス層で共通利用する。 |
| walletHistory | `domain.json` | ウォレット履歴ドメインの生成設定。`change_method`, `points_delta`, `source_type`, `meta` など履歴固有フィールドを定義。 |
| walletHistory | `entities/*` | `wallet_history` テーブルの Drizzle/Zod/モデル定義。 |
| walletHistory | `services/server/walletHistoryService.ts` | 履歴検索やメタ情報を用いたフィルタリングなど、履歴向けサーバーサービス（必要に応じて追加）。 |
| walletHistory | `services/server/wrappers/*` | 履歴出力フォーマット変換や監査向け集計など、用途別に追加できる拡張ポイント。 |
| walletHistory | `services/client/walletHistoryClient.ts` | 履歴取得 API クライアント。管理画面での履歴一覧や将来のユーザー向け明細表示で利用。 |
| walletHistory | `hooks/*` | 履歴の一覧・検索用フック。ポイント操作モーダルや監査画面で利用。 |
| admin API | `app/api/admin/wallet/[userId]/adjust/route.ts`（新規） | 管理者によるポイント操作 API。`walletService` の `mutateBalance` を呼び出し、HTTP I/F を整形する。 |
| admin UI | `features/core/user/components/AdminUserList/**`（改修） | 一覧テーブルの操作列に「ポイント操作」ボタンを追加し、モーダルを表示する。 |
| admin UI | `features/core/wallet/components/AdminWalletAdjustModal/**`（新規） | 管理者用ポイント調整モーダルとフォーム。`useWallet` / `useAdjustWallet` を利用し、入力値を API に渡す。 |
| registry | `src/registry/schemaRegistry.ts` | `wallet` / `wallet_history` の Drizzle エントリを登録し、マイグレーション対象に含める。 |
| DB migration | `drizzle/*.sql` | `db:generate` 実行時に作成されるマイグレーション。`wallet` 追加や列変更がここに出力され、`db:push` で Neon へ適用される。 |
| docs | `docs/concepts/ウォレット機能の設計方針と運用ガイド.md` | 本ドキュメント。設計方針・メタ情報運用・ファイル構成をまとめ、実装全体の基準とする。 |

> サービス層は「ベース CRUD (`drizzleBase.ts`)」「ドメインロジック本体 (`walletService.ts`)」「責務別ラッパー (`wrappers/*.ts`)」に分割し、1 ファイルにすべての操作を詰め込まない。新しい操作（例: 決済連携、予約フロー、バッチ失効）を追加する際は `wrappers/` に専用モジュールを増やし、`walletService.ts` 自体の肥大化を防ぐ。
