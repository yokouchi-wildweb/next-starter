# ã‚³ã‚¤ãƒ³è³¼å…¥æ™‚ã®æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã¨å¤–éƒ¨æ±ºæ¸ˆé€£æºã«é–¢ã™ã‚‹å‡¦ç†æ–¹é‡

ã‚¢ãƒ—ãƒªå†…é€šè²¨ï¼ˆã‚³ã‚¤ãƒ³ã€ãƒã‚¤ãƒ³ãƒˆç­‰ï¼‰ã®è³¼å…¥æ©Ÿèƒ½ã«ãŠã‘ã‚‹æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã€çŠ¶æ…‹ç®¡ç†ã€äºŒé‡è³¼å…¥é˜²æ­¢ã®è¨­è¨ˆã‚’ã¾ã¨ã‚ã¾ã™ã€‚

> **é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ**: ã‚¦ã‚©ãƒ¬ãƒƒãƒˆã®åŸºæœ¬è¨­è¨ˆã«ã¤ã„ã¦ã¯ [ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ©Ÿèƒ½ã®è¨­è¨ˆæ–¹é‡ã¨é‹ç”¨ã‚¬ã‚¤ãƒ‰](./ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ©Ÿèƒ½ã®è¨­è¨ˆæ–¹é‡ã¨é‹ç”¨ã‚¬ã‚¤ãƒ‰.md) ã‚’å‚ç…§ã€‚

---

## ğŸ›’ 1. è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç®¡ç†ï¼ˆpurchase_requestsï¼‰

### èƒŒæ™¯ã¨ç›®çš„

ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‹æ±ºæ¸ˆï¼ˆStripe Checkoutã€PayPayã€ã‚³ãƒ³ãƒ“ãƒ‹æ±ºæ¸ˆç­‰ï¼‰ã§ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå¤–éƒ¨æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«é·ç§»ã—ã€æ”¯æ‰•ã„å®Œäº†å¾Œã«æˆ»ã£ã¦ãã‚‹ã¾ã§ã€Œå‡¦ç†ä¸­ã€ã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å¿…è¦ãŒã‚ã‚‹ã€‚

`wallet_history` ã¯ã€Œå®Œäº†ã—ãŸæ®‹é«˜å¤‰æ›´ã€ã‚’è¨˜éŒ²ã™ã‚‹ãƒ†ãƒ¼ãƒ–ãƒ«ã§ã‚ã‚Šã€ä»¥ä¸‹ã®ä¸­é–“çŠ¶æ…‹ã¯è¡¨ç¾ã§ããªã„ï¼š
- æ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«é·ç§»ä¸­ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã¾ã æ”¯æ‰•ã£ã¦ã„ãªã„ï¼‰
- æ”¯æ‰•ã„å‡¦ç†ä¸­ï¼ˆæ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ãŒå‡¦ç†ä¸­ï¼‰
- æ”¯æ‰•ã„å¤±æ•—ï¼ˆæ®‹é«˜å¤‰æ›´ã¯ç™ºç”Ÿã—ãªã„ï¼‰

ãã®ãŸã‚ã€è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®çŠ¶æ…‹ã‚’ç®¡ç†ã™ã‚‹å°‚ç”¨ãƒ†ãƒ¼ãƒ–ãƒ« `purchase_requests` ã‚’å°å…¥ã™ã‚‹ã€‚

### purchase_requests ãƒ†ãƒ¼ãƒ–ãƒ«æ§‹é€ 

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ | å‹ | èª¬æ˜ |
| --- | --- | --- |
| `id` | UUID | ãƒªã‚¯ã‚¨ã‚¹ãƒˆIDï¼ˆä¸»ã‚­ãƒ¼ï¼‰ |
| `user_id` | UUID | è³¼å…¥ãƒ¦ãƒ¼ã‚¶ãƒ¼ |
| `idempotency_key` | UUID | å†ªç­‰ã‚­ãƒ¼ï¼ˆUNIQUEåˆ¶ç´„ã€äºŒé‡è³¼å…¥é˜²æ­¢ï¼‰ |
| `wallet_type` | ENUM | å¯¾è±¡ã‚¦ã‚©ãƒ¬ãƒƒãƒˆç¨®åˆ¥ï¼ˆ`regular_coin` ç­‰ï¼‰ |
| `amount` | INTEGER | è³¼å…¥æ•°é‡ï¼ˆã‚³ã‚¤ãƒ³æ•°ãªã©ï¼‰ |
| `payment_amount` | INTEGER | æ”¯æ‰•ã„é‡‘é¡ï¼ˆå††ï¼‰ |
| `payment_method` | TEXT | æ”¯æ‰•ã„æ–¹æ³•ï¼ˆ`credit_card` / `amazon_pay` / `convenience_store` / `bank_transfer`ï¼‰ |
| `status` | ENUM | `pending` â†’ `processing` â†’ `completed` / `failed` / `expired` |
| `payment_provider` | TEXT | æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ï¼ˆ`dummy` / `stripe` / `paypay` ç­‰ï¼‰ |
| `payment_session_id` | TEXT | å¤–éƒ¨æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³IDï¼ˆnullableï¼‰ |
| `wallet_history_id` | UUID | å®Œäº†æ™‚ã«ä½œæˆã•ã‚ŒãŸ wallet_history ã®IDï¼ˆnullableï¼‰ |
| `error_code` | TEXT | ã‚¨ãƒ©ãƒ¼æ™‚ã®ã‚³ãƒ¼ãƒ‰ï¼ˆnullableï¼‰ |
| `error_message` | TEXT | ã‚¨ãƒ©ãƒ¼æ™‚ã®è©³ç´°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆnullableï¼‰ |
| `milestone_results` | JSONB | ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è©•ä¾¡çµæœï¼ˆnullableã€`PersistedMilestoneResult[]`ï¼‰ |
| `created_at` | TIMESTAMP | ä½œæˆæ—¥æ™‚ |
| `updated_at` | TIMESTAMP | æ›´æ–°æ—¥æ™‚ |
| `completed_at` | TIMESTAMP | å®Œäº†æ—¥æ™‚ï¼ˆnullableï¼‰ |
| `expires_at` | TIMESTAMP | æœ‰åŠ¹æœŸé™ï¼ˆnullableã€æœªå®Œäº†ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®è‡ªå‹•å¤±åŠ¹ç”¨ï¼‰ |

### ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ pending â”‚ â† è³¼å…¥é–‹å§‹ã€æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå‰
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
     â”‚ æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ processing â”‚ â† ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã§æ”¯æ‰•ã„ä¸­
â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€â”€ æ”¯æ‰•ã„æˆåŠŸï¼ˆWebhookï¼‰ â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                              â”‚ completed â”‚ â†’ walletæ®‹é«˜æ›´æ–°
      â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â”œâ”€â”€â”€ æ”¯æ‰•ã„å¤±æ•—ï¼ˆWebhookï¼‰ â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”
      â”‚                              â”‚ failed â”‚
      â”‚                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜
      â”‚
      â””â”€â”€â”€ æœ‰åŠ¹æœŸé™åˆ‡ã‚Œ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â†’ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                     â”‚ expired â”‚
                                     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### wallet / wallet_history ã¨ã®é–¢ä¿‚

```
purchase_requests (1) â”€â”€â†’ (0..1) wallet_history
        â”‚
        â”‚ å®Œäº†æ™‚ã®ã¿å±¥æ­´ãŒä½œæˆã•ã‚Œã‚‹
        â”‚
        â””â”€â”€â†’ wallet_history.request_batch_id = purchase_requests.id
             ã¨ã—ã¦ç´ä»˜ã‘å¯èƒ½
```

- `purchase_requests` ã¯ã€Œè³¼å…¥ã®æ„å›³ã¨çŠ¶æ…‹ã€ã‚’ç®¡ç†
- `wallet_history` ã¯ã€Œå®Ÿéš›ã«ç™ºç”Ÿã—ãŸæ®‹é«˜å¤‰æ›´ã€ã‚’è¨˜éŒ²
- ä¸¡è€…ã¯ç‹¬ç«‹ã—ã¦ãŠã‚Šã€è³¼å…¥ãŒå®Œäº†ã—ãŸå ´åˆã®ã¿ `wallet_history` ã«ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒä½œæˆã•ã‚Œã‚‹

---

## ğŸ’³ 2. æ±ºæ¸ˆãƒ•ãƒ­ãƒ¼ã®è¨­è¨ˆ

### ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‹æ±ºæ¸ˆã®å…¨ä½“ãƒ•ãƒ­ãƒ¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒè³¼å…¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã™                                              â”‚
â”‚    â””â”€â†’ POST /api/wallet/purchase/initiate                                â”‚
â”‚        â”œâ”€ idempotency_key ã§æ—¢å­˜ãƒã‚§ãƒƒã‚¯ï¼ˆäºŒé‡è³¼å…¥é˜²æ­¢ï¼‰                   â”‚
â”‚        â”œâ”€ purchase_request ä½œæˆï¼ˆstatus: pendingï¼‰                        â”‚
â”‚        â””â”€ æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒªã‚¯ã‚¨ã‚¹ãƒˆ                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 2. æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆå®Œäº†                                                  â”‚
â”‚    â””â”€â†’ purchase_request æ›´æ–°ï¼ˆstatus: processing, payment_session_idï¼‰    â”‚
â”‚    â””â”€â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«æ±ºæ¸ˆãƒšãƒ¼ã‚¸URLã‚’è¿”å´                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã§æ”¯æ‰•ã„                                            â”‚
â”‚    â””â”€â†’ å¤–éƒ¨æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã®ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 4. æ”¯æ‰•ã„å®Œäº†å¾Œã®ä¸¦è¡Œå‡¦ç†                                                  â”‚
â”‚                                                                          â”‚
â”‚    [WebhookçµŒè·¯] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚    â”‚  POST /api/webhook/payment                                          â”‚
â”‚    â”‚  â”œâ”€ payment_session_id ã§ purchase_request ã‚’æ¤œç´¢                   â”‚
â”‚    â”‚  â”œâ”€ adjustBalance() ã§ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ®‹é«˜ã‚’æ›´æ–° â† ã€æ¨©å¨ã‚ã‚‹ã‚½ãƒ¼ã‚¹ã€‘       â”‚
â”‚    â”‚  â””â”€ purchase_request æ›´æ–°ï¼ˆstatus: completed, wallet_history_idï¼‰   â”‚
â”‚    â”‚                                                                      â”‚
â”‚    [ãƒ¦ãƒ¼ã‚¶ãƒ¼çµŒè·¯] â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€    â”‚
â”‚    â”‚  ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: /coins/purchase/callback?request_id=xxx              â”‚
â”‚    â”‚  â””â”€ purchase_request ã® status ã‚’ç¢ºèª                               â”‚
â”‚    â”‚     â”œâ”€ completed â†’ /coins/purchase/complete ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ          â”‚
â”‚    â”‚     â”œâ”€ processing â†’ ãƒãƒ¼ãƒªãƒ³ã‚°ã§ Webhook å®Œäº†ã‚’å¾…æ©Ÿ                  â”‚
â”‚    â”‚     â””â”€ failed/expired â†’ /coins/purchase/failed ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ãƒšãƒ¼ã‚¸æ§‹æˆ

| ãƒšãƒ¼ã‚¸ | ãƒ‘ã‚¹ | å½¹å‰² |
| --- | --- | --- |
| è³¼å…¥å†…å®¹ç¢ºèª | `/coins/purchase` | è³¼å…¥æ•°é‡ãƒ»æ”¯æ‰•ã„æ–¹æ³•ã‚’é¸æŠ |
| ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ | `/coins/purchase/callback` | æ±ºæ¸ˆå¾Œã®çŠ¶æ…‹æ¤œè¨¼ãƒ»æŒ¯ã‚Šåˆ†ã‘ |
| å®Œäº† | `/coins/purchase/complete` | è³¼å…¥æˆåŠŸã®è¡¨ç¤º |
| å¤±æ•— | `/coins/purchase/failed` | è³¼å…¥å¤±æ•—ãƒ»ã‚¨ãƒ©ãƒ¼ã®è¡¨ç¤º |

---

## ğŸ”„ 3. Callback ã¨ Webhook ã®å½¹å‰²åˆ†æ‹…

Callback ãƒšãƒ¼ã‚¸ã¨ Webhook ã¯**è£œå®Œé–¢ä¿‚**ã«ã‚ã‚Šã€ä¸¡æ–¹ãŒå¿…è¦ã€‚

| è¦³ç‚¹ | Callback ãƒšãƒ¼ã‚¸ | Webhook |
| --- | --- | --- |
| ä¸»ãªå½¹å‰² | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¸ã®å³æ™‚ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ | ç¢ºå®Ÿãªæ±ºæ¸ˆå®Œäº†ã®è¨˜éŒ² |
| åˆ°é”ä¿è¨¼ | âŒ ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæˆ»ã‚‰ãªã„å¯èƒ½æ€§ã‚ã‚Š | âœ… ã‚µãƒ¼ãƒãƒ¼é–“é€šä¿¡ï¼‹ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹ |
| éåŒæœŸæ±ºæ¸ˆ | âŒ å¯¾å¿œä¸å¯ï¼ˆã‚³ãƒ³ãƒ“ãƒ‹æ‰•ã„ç­‰ï¼‰ | âœ… å®Œäº†æ™‚ã«é€šçŸ¥ã•ã‚Œã‚‹ |
| ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ | â–³ URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯æ”¹ã–ã‚“å¯èƒ½ | âœ… ç½²åæ¤œè¨¼ã§ä¿è¨¼ |
| æ®‹é«˜æ›´æ–° | âŒ è¡Œã‚ãªã„ï¼ˆå‚ç…§ã®ã¿ï¼‰ | âœ… ã“ã“ã§å®Ÿè¡Œ |

**é‡è¦**: å®Ÿéš›ã®ã‚³ã‚¤ãƒ³ä»˜ä¸ï¼ˆæ®‹é«˜æ›´æ–°ï¼‰ã¯å¿…ãš Webhook å´ã§è¡Œã†ã€‚Callback ãƒšãƒ¼ã‚¸ã¯ DB ã®çŠ¶æ…‹ã‚’ç¢ºèªã—ã¦è¡¨ç¤ºã™ã‚‹ã ã‘ã€‚

### Callback ãƒšãƒ¼ã‚¸ãŒå¿…è¦ãªç†ç”±

1. **Webhook ã¨ã®ç«¶åˆçŠ¶æ…‹ã®å¸å**
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã§æˆ»ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¨ Webhook åˆ°ç€ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã¯ä¸å®š
   - Callback ãƒšãƒ¼ã‚¸ã§ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦ Webhook å®Œäº†ã‚’å¾…æ©Ÿã§ãã‚‹

2. **çŠ¶æ…‹æ¤œè¨¼ã®ä¸€å…ƒåŒ–**
   - ã‚»ãƒƒã‚·ãƒ§ãƒ³ã¨ purchase_request ã®ç…§åˆ
   - ä¸æ­£ã‚¢ã‚¯ã‚»ã‚¹é˜²æ­¢ï¼ˆç›´æ¥ complete ãƒšãƒ¼ã‚¸ã«ã‚¢ã‚¯ã‚»ã‚¹ã•ã›ãªã„ï¼‰

3. **UX ã®æ”¹å–„**
   - æ¤œè¨¼ä¸­ã¯ã€Œå‡¦ç†ä¸­...ã€ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
   - æ¤œè¨¼å®Œäº†å¾Œã«é©åˆ‡ãªãƒšãƒ¼ã‚¸ã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ

### Callback ãƒšãƒ¼ã‚¸ã®å‡¦ç†ãƒ•ãƒ­ãƒ¼

```typescript
// /coins/purchase/callback?request_id=xxx

async function CallbackPage({ searchParams }) {
  const requestId = searchParams.request_id;

  // 1. purchase_request ã‚’å–å¾—
  const purchaseRequest = await getPurchaseRequest(requestId);

  // 2. ã‚»ãƒƒã‚·ãƒ§ãƒ³æ¤œè¨¼ï¼ˆãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ä¸€è‡´ã™ã‚‹ã‹ï¼‰
  if (purchaseRequest.userId !== currentUser.id) {
    redirect("/coins/purchase/failed?error=unauthorized");
  }

  // 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã«å¿œã˜ãŸå‡¦ç†
  switch (purchaseRequest.status) {
    case "completed":
      redirect("/coins/purchase/complete?request_id=" + requestId);

    case "failed":
    case "expired":
      redirect("/coins/purchase/failed?request_id=" + requestId);

    case "processing":
      // Webhook ãŒã¾ã åˆ°ç€ã—ã¦ã„ãªã„
      // â†’ ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ã§ãƒãƒ¼ãƒªãƒ³ã‚°ã—ã¦å¾…æ©Ÿ
      return <CallbackPolling requestId={requestId} />;

    default:
      redirect("/coins/purchase/failed?error=invalid_status");
  }
}
```

### ãƒãƒ¼ãƒªãƒ³ã‚°å‡¦ç†ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´ï¼‰

```typescript
// CallbackPolling ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ

function CallbackPolling({ requestId }: { requestId: string }) {
  const [status, setStatus] = useState<string>("processing");
  const [retryCount, setRetryCount] = useState(0);
  const MAX_RETRIES = 10;
  const POLL_INTERVAL = 2000; // 2ç§’

  useEffect(() => {
    const poll = async () => {
      const result = await checkPurchaseStatus(requestId);

      if (result.status === "completed") {
        router.push(`/coins/purchase/complete?request_id=${requestId}`);
        return;
      }

      if (result.status === "failed" || result.status === "expired") {
        router.push(`/coins/purchase/failed?request_id=${requestId}`);
        return;
      }

      // ã¾ã  processing ã®å ´åˆ
      if (retryCount >= MAX_RETRIES) {
        // ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ â†’ ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºï¼ˆã‚µãƒãƒ¼ãƒˆæ¡ˆå†…ï¼‰
        setStatus("timeout");
        return;
      }

      setRetryCount((c) => c + 1);
      setTimeout(poll, POLL_INTERVAL);
    };

    poll();
  }, [requestId, retryCount]);

  if (status === "timeout") {
    return <TimeoutError requestId={requestId} />;
  }

  return <LoadingSpinner message="æ±ºæ¸ˆçµæœã‚’ç¢ºèªä¸­..." />;
}
```

---

## ğŸ”Œ 4. æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã®æŠ½è±¡åŒ–

å°†æ¥çš„ã«è¤‡æ•°ã®æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã«å¯¾å¿œã™ã‚‹ãŸã‚ã€å…±é€šã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚

```typescript
// src/features/core/wallet/services/server/payment/types.ts

/** æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ */
type CreatePaymentSessionParams = {
  purchaseRequestId: string;
  amount: number;          // æ”¯æ‰•ã„é‡‘é¡ï¼ˆå††ï¼‰
  userId: string;
  successUrl: string;      // æ”¯æ‰•ã„æˆåŠŸæ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ
  cancelUrl: string;       // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå…ˆ
  metadata?: Record<string, string>;
  buyerEmail?: string;           // è³¼å…¥è€…ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹
  buyerPhoneNumber?: string;     // è³¼å…¥è€…é›»è©±ç•ªå·ï¼ˆE.164å½¢å¼ï¼‰
  buyerAddress?: BuyerAddress;   // è³¼å…¥è€…ä½æ‰€æƒ…å ±
  providerOptions?: Record<string, unknown>;  // ãƒ—ãƒ­ãƒã‚¤ãƒ€å›ºæœ‰ã‚ªãƒ—ã‚·ãƒ§ãƒ³
};

/** æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ */
type PaymentSession = {
  sessionId: string;       // æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹å´ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ID
  redirectUrl: string;     // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã™ã‚‹URL
  expiresAt?: Date;        // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æœ‰åŠ¹æœŸé™
};

/** æ±ºæ¸ˆçµæœ */
type PaymentResult = {
  success: boolean;
  sessionId: string;
  errorCode?: string;
  errorMessage?: string;
};

/** æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ */
interface PaymentProvider {
  readonly providerName: string;

  /** æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ */
  createSession(params: CreatePaymentSessionParams): Promise<PaymentSession>;

  /** Webhookãƒšã‚¤ãƒ­ãƒ¼ãƒ‰ã‚’æ¤œè¨¼ãƒ»ãƒ‘ãƒ¼ã‚¹ */
  parseWebhookPayload(request: Request): Promise<PaymentResult>;
}
```

### ãƒ€ãƒŸãƒ¼æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€

é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ€ãƒŸãƒ¼å®Ÿè£…ã€‚å³åº§ã«æˆåŠŸã‚’è¿”ã—ã€ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆã™ã‚‹ã€‚

```typescript
// src/features/core/wallet/services/server/payment/dummyProvider.ts

class DummyPaymentProvider implements PaymentProvider {
  readonly providerName = "dummy";

  async createSession(params: CreatePaymentSessionParams): Promise<PaymentSession> {
    // ãƒ€ãƒŸãƒ¼: å³åº§ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä½œæˆ
    const sessionId = `dummy_${params.purchaseRequestId}`;

    return {
      sessionId,
      // ãƒ€ãƒŸãƒ¼æ±ºæ¸ˆç¢ºèªãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
      redirectUrl: `/coins/purchase/confirm?session_id=${sessionId}`,
      expiresAt: new Date(Date.now() + 30 * 60 * 1000), // 30åˆ†
    };
  }

  async parseWebhookPayload(request: Request): Promise<PaymentResult> {
    // ãƒ€ãƒŸãƒ¼: ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã‹ã‚‰ã‚»ãƒƒã‚·ãƒ§ãƒ³IDã‚’å–å¾—
    const body = await request.json();
    return {
      success: true,
      sessionId: body.sessionId,
    };
  }
}
```

### ãƒ—ãƒ­ãƒã‚¤ãƒ€ã®åˆ‡ã‚Šæ›¿ãˆ

ç’°å¢ƒå¤‰æ•°ã¾ãŸã¯ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã§æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’é¸æŠã€‚

```typescript
// src/features/core/wallet/services/server/payment/index.ts

function getPaymentProvider(providerName: string): PaymentProvider {
  switch (providerName) {
    case "dummy":
      return new DummyPaymentProvider();
    case "stripe":
      return new StripePaymentProvider(); // å°†æ¥å®Ÿè£…
    case "paypay":
      return new PayPayProvider();        // å°†æ¥å®Ÿè£…
    default:
      throw new Error(`Unknown payment provider: ${providerName}`);
  }
}
```

---

## ğŸ›¡ï¸ 5. äºŒé‡è³¼å…¥é˜²æ­¢ã¨å†ªç­‰æ€§

### äºŒé‡è³¼å…¥ãŒç™ºç”Ÿã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

| ãƒ‘ã‚¿ãƒ¼ãƒ³ | åŸå›  | å¯¾ç­–ãƒ¬ã‚¤ãƒ¤ãƒ¼ |
| --- | --- | --- |
| ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ | ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒœã‚¿ãƒ³ã‚’é€£æ‰“ | UIï¼ˆãƒœã‚¿ãƒ³ç„¡åŠ¹åŒ–ï¼‰ |
| ãƒªãƒ­ãƒ¼ãƒ‰ | æ±ºæ¸ˆä¸­ã«ãƒšãƒ¼ã‚¸ã‚’ãƒªãƒ­ãƒ¼ãƒ‰ | APIï¼ˆå†ªç­‰ã‚­ãƒ¼ï¼‰ |
| æˆ»ã‚‹ãƒœã‚¿ãƒ³ | å®Œäº†å¾Œã«æˆ»ã£ã¦å†é€ä¿¡ | APIï¼ˆå†ªç­‰ã‚­ãƒ¼ï¼‰ |
| ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯é…å»¶ | ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå¾Œã®ãƒªãƒˆãƒ©ã‚¤ | APIï¼ˆå†ªç­‰ã‚­ãƒ¼ï¼‰ |
| Webhooké‡è¤‡ | æ±ºæ¸ˆã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã®è¤‡æ•°é€šçŸ¥ | DBï¼ˆã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒã‚§ãƒƒã‚¯ï¼‰ |
| è¤‡æ•°ã‚¿ãƒ– | åŒæ™‚ã«è³¼å…¥ãƒšãƒ¼ã‚¸ã‚’é–‹ã | DBï¼ˆUNIQUEåˆ¶ç´„ï¼‰ |

### å¤šå±¤é˜²å¾¡ã®å®Ÿè£…

#### 1. UIãƒ¬ãƒ™ãƒ«ï¼ˆè£œåŠ©çš„ï¼‰

```tsx
// è³¼å…¥ãƒœã‚¿ãƒ³ã®ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹
const [isSubmitting, setIsSubmitting] = useState(false);

<Button
  disabled={isSubmitting}
  onClick={handlePurchase}
>
  {isSubmitting ? "å‡¦ç†ä¸­..." : "è³¼å…¥ã™ã‚‹"}
</Button>
```

#### 2. APIãƒ¬ãƒ™ãƒ«ï¼ˆå†ªç­‰ã‚­ãƒ¼ï¼‰

```typescript
// ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆå´: è³¼å…¥é–‹å§‹æ™‚ã«UUIDã‚’ç”Ÿæˆ
const idempotencyKey = crypto.randomUUID();

// ã‚µãƒ¼ãƒãƒ¼å´: åŒã˜ã‚­ãƒ¼ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¯æ—¢å­˜ã‚’è¿”ã™
async function initiatePurchase(params: InitiatePurchaseParams) {
  // å†ªç­‰ã‚­ãƒ¼ã§æ—¢å­˜ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’æ¤œç´¢
  const existing = await findPurchaseRequestByIdempotencyKey(params.idempotencyKey);

  if (existing) {
    // æ—¢ã«å‡¦ç†æ¸ˆã¿ or å‡¦ç†ä¸­ãªã‚‰æ—¢å­˜ã®çµæœã‚’è¿”ã™
    if (existing.status === "completed") {
      return { success: true, alreadyCompleted: true };
    }
    if (existing.status === "processing") {
      return { redirectUrl: existing.redirectUrl };
    }
    // pending ã®å ´åˆã¯å†åˆ©ç”¨ã—ã¦ç¶šè¡Œ
  }

  // æ–°è¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ
  // ...
}
```

#### 3. DBãƒ¬ãƒ™ãƒ«ï¼ˆUNIQUEåˆ¶ç´„ + ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç®¡ç†ï¼‰

```sql
-- idempotency_key ã«UNIQUEåˆ¶ç´„
CREATE UNIQUE INDEX purchase_requests_idempotency_key_idx
  ON purchase_requests(idempotency_key);

-- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°æ™‚ã®æ¥½è¦³çš„ãƒ­ãƒƒã‚¯
UPDATE purchase_requests
SET status = 'completed', completed_at = NOW()
WHERE id = $1 AND status = 'processing'
RETURNING *;
-- 0è¡Œæ›´æ–° = æ—¢ã«åˆ¥ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã§æ›´æ–°æ¸ˆã¿
```

#### 4. Webhookãƒ¬ãƒ™ãƒ«ï¼ˆã¹ãç­‰å‡¦ç†ï¼‰

```typescript
async function handlePaymentWebhook(payload: PaymentResult) {
  const purchaseRequest = await findByPaymentSessionId(payload.sessionId);

  // æ—¢ã«å®Œäº†æ¸ˆã¿ãªã‚‰ä½•ã‚‚ã—ãªã„ï¼ˆWebhooké‡è¤‡å¯¾ç­–ï¼‰
  if (purchaseRequest.status === "completed") {
    return { success: true, message: "Already processed" };
  }

  // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰
  const updated = await updateStatusToCompleted(purchaseRequest.id);
  if (!updated) {
    // ç«¶åˆç™ºç”Ÿ = åˆ¥ã®Webhookã§æ—¢ã«å‡¦ç†æ¸ˆã¿
    return { success: true, message: "Processed by another request" };
  }

  // ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ®‹é«˜æ›´æ–°
  await adjustBalance({
    userId: purchaseRequest.userId,
    walletType: purchaseRequest.walletType,
    changeMethod: "INCREMENT",
    amount: purchaseRequest.amount,
    sourceType: "user_action",
    requestBatchId: purchaseRequest.id,
    meta: { purchaseRequestId: purchaseRequest.id }
  });
}
```

### å†ªç­‰ã‚­ãƒ¼ã®æœ‰åŠ¹æœŸé™

- å†ªç­‰ã‚­ãƒ¼ã¯æ°¸ç¶šçš„ã«ä¿æŒã™ã‚‹å¿…è¦ã¯ãªã„
- ä¸€å®šæœŸé–“ï¼ˆä¾‹: 24æ™‚é–“ï¼‰çµŒéå¾Œã¯åŒã˜ã‚­ãƒ¼ã§ã‚‚æ–°è¦ãƒªã‚¯ã‚¨ã‚¹ãƒˆã¨ã—ã¦æ‰±ã†
- `purchase_requests.expires_at` ã§ç®¡ç†ã—ã€ãƒãƒƒãƒã‚¸ãƒ§ãƒ–ã§æœŸé™åˆ‡ã‚Œãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ `expired` ã«æ›´æ–°

---

## ğŸ“‹ 6. å®Ÿè£…ãƒã‚§ãƒƒã‚¯ãƒªã‚¹ãƒˆ

### è³¼å…¥é–‹å§‹æ™‚
- [ ] ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã§å†ªç­‰ã‚­ãƒ¼ï¼ˆUUIDï¼‰ã‚’ç”Ÿæˆã—ã¦ã„ã‚‹ã‹
- [ ] è³¼å…¥ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸç›´å¾Œã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã«ã—ã¦ã„ã‚‹ã‹
- [ ] `purchase_requests` ã«æ–°è¦ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä½œæˆã—ã¦ã„ã‚‹ã‹
- [ ] æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ã«ã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆã—ã¦ã„ã‚‹ã‹

### æ±ºæ¸ˆä¸­
- [ ] ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é©åˆ‡ãªæ±ºæ¸ˆãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã‚‹ã‹
- [ ] `purchase_requests.status` ã‚’ `processing` ã«æ›´æ–°ã—ã¦ã„ã‚‹ã‹
- [ ] `payment_session_id` ã‚’è¨˜éŒ²ã—ã¦ã„ã‚‹ã‹

### Webhookå—ä¿¡æ™‚
- [ ] Webhookã®ç½²åæ¤œè¨¼ã‚’ã—ã¦ã„ã‚‹ã‹ï¼ˆæœ¬ç•ªç’°å¢ƒï¼‰
- [ ] `payment_session_id` ã§ `purchase_requests` ã‚’æ¤œç´¢ã—ã¦ã„ã‚‹ã‹
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒ `processing` ã®å ´åˆã®ã¿å‡¦ç†ã—ã¦ã„ã‚‹ã‹ï¼ˆã¹ãç­‰æ€§ï¼‰
- [ ] `adjustBalance` ã§ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ®‹é«˜ã‚’æ›´æ–°ã—ã¦ã„ã‚‹ã‹
- [ ] `wallet_history_id` ã‚’è¨˜éŒ²ã—ã¦ã„ã‚‹ã‹
- [ ] `purchase_requests.status` ã‚’ `completed` ã«æ›´æ–°ã—ã¦ã„ã‚‹ã‹
- [ ] `evaluateMilestones()` ã§ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³è©•ä¾¡ã‚’å®Ÿè¡Œã—ã¦ã„ã‚‹ã‹
- [ ] ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³çµæœã‚’ `purchase_requests.milestone_results` ã«ä¿å­˜ã—ã¦ã„ã‚‹ã‹

### ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒšãƒ¼ã‚¸
- [ ] `request_id` ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã„ã‚‹ã‹
- [ ] ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ `purchase_request.user_id` ã‚’ç…§åˆã—ã¦ã„ã‚‹ã‹
- [ ] `status` ã«å¿œã˜ã¦é©åˆ‡ãªãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã‚‹ã‹
- [ ] `processing` çŠ¶æ…‹ã®å ´åˆã€ãƒãƒ¼ãƒªãƒ³ã‚°ã§ Webhook å®Œäº†ã‚’å¾…æ©Ÿã—ã¦ã„ã‚‹ã‹
- [ ] ãƒãƒ¼ãƒªãƒ³ã‚°ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå‡¦ç†ã‚’å®Ÿè£…ã—ã¦ã„ã‚‹ã‹
- [ ] ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆæ™‚ã«ã‚µãƒãƒ¼ãƒˆæ¡ˆå†…ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹

### å®Œäº†å¾Œ
- [ ] å®Œäº†ãƒšãƒ¼ã‚¸ã§è³¼å…¥å†…å®¹ï¼ˆæ•°é‡ãƒ»é‡‘é¡ï¼‰ã‚’è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹
- [ ] ãƒã‚¤ãƒ«ã‚¹ãƒˆãƒ¼ãƒ³é”æˆé€šçŸ¥ãŒè¡¨ç¤ºã•ã‚Œã¦ã„ã‚‹ã‹ï¼ˆ`milestoneResults` ãŒå­˜åœ¨ã™ã‚‹å ´åˆï¼‰
- [ ] ãƒˆãƒ¼ã‚¹ãƒˆã§è³¼å…¥å®Œäº†ã‚’é€šçŸ¥ã—ã¦ã„ã‚‹ã‹
- [ ] æ®‹é«˜è¡¨ç¤ºã‚’æ›´æ–°ã—ã¦ã„ã‚‹ã‹ï¼ˆSWRå†æ¤œè¨¼ï¼‰
- [ ] ã‚³ã‚¤ãƒ³ç®¡ç†ãƒšãƒ¼ã‚¸ã¸ã®å°ç·šã‚’ç”¨æ„ã—ã¦ã„ã‚‹ã‹

### ã‚¨ãƒ©ãƒ¼å‡¦ç†
- [ ] æ±ºæ¸ˆå¤±æ•—æ™‚ã« `status` ã‚’ `failed` ã«æ›´æ–°ã—ã¦ã„ã‚‹ã‹
- [ ] ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«è¡¨ç¤ºã—ã¦ã„ã‚‹ã‹
- [ ] æœŸé™åˆ‡ã‚Œãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’å®šæœŸçš„ã« `expired` ã«æ›´æ–°ã—ã¦ã„ã‚‹ã‹

---

## ğŸ“ 7. é–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹

| åˆ©ç”¨ã‚·ãƒ¼ãƒ³ | ãƒ•ã‚¡ã‚¤ãƒ« / é–¢æ•° | ãƒã‚¤ãƒ³ãƒˆ |
| --- | --- | --- |
| è³¼å…¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆä½œæˆ | `src/features/core/wallet/services/server/purchase/initiatePurchase.ts` | å†ªç­‰ã‚­ãƒ¼ãƒã‚§ãƒƒã‚¯ã€purchase_requestä½œæˆã€æ±ºæ¸ˆã‚»ãƒƒã‚·ãƒ§ãƒ³ä½œæˆ |
| æ±ºæ¸ˆãƒ—ãƒ­ãƒã‚¤ãƒ€ | `src/features/core/wallet/services/server/payment/index.ts` | `getPaymentProvider()` ã§ãƒ—ãƒ­ãƒã‚¤ãƒ€ã‚’å–å¾— |
| Webhookå‡¦ç† | `src/app/api/webhook/payment/route.ts` | æ±ºæ¸ˆå®Œäº†é€šçŸ¥ã®å—ä¿¡ã€ã‚¦ã‚©ãƒ¬ãƒƒãƒˆæ›´æ–° |
| è³¼å…¥å®Œäº†ç¢ºèª | `src/features/core/wallet/services/server/purchase/getPurchaseStatus.ts` | purchase_request ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å–å¾— |
| UIã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | `src/features/core/wallet/components/UserBalance/`, `src/features/core/wallet/components/CurrencyPurchase/` | æ®‹é«˜è¡¨ç¤ºã€è³¼å…¥ãƒ•ã‚©ãƒ¼ãƒ  |

### ãƒšãƒ¼ã‚¸ä¸€è¦§

| ãƒšãƒ¼ã‚¸ | ãƒ•ã‚¡ã‚¤ãƒ« | å½¹å‰² |
| --- | --- | --- |
| ã‚³ã‚¤ãƒ³ç®¡ç† | `src/app/(user)/(protected)/coins/page.tsx` | æ®‹é«˜è¡¨ç¤ºã€è³¼å…¥ã‚ªãƒ—ã‚·ãƒ§ãƒ³ä¸€è¦§ |
| è³¼å…¥ç¢ºèª | `src/app/(user)/(protected)/coins/purchase/page.tsx` | è³¼å…¥æ•°é‡ãƒ»æ”¯æ‰•ã„æ–¹æ³•é¸æŠ |
| ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ | `src/app/(user)/(protected)/coins/purchase/callback/page.tsx` | æ±ºæ¸ˆå¾Œã®çŠ¶æ…‹æ¤œè¨¼ã€ãƒãƒ¼ãƒªãƒ³ã‚°å¾…æ©Ÿ |
| å®Œäº† | `src/app/(user)/(protected)/coins/purchase/complete/page.tsx` | è³¼å…¥æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ |
| å¤±æ•— | `src/app/(user)/(protected)/coins/purchase/failed/page.tsx` | ã‚¨ãƒ©ãƒ¼è¡¨ç¤ºã€ã‚µãƒãƒ¼ãƒˆæ¡ˆå†… |

---
