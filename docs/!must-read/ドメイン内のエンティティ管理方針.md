# エンティティ管理方針

このドキュメントでは、各ドメイン配下の `entities/` フォルダにおけるスキーマと型定義の配置規則をまとめます。フォームごとに固有の入力要件が増えた状況でも、サーバー側で扱う共通の正規化スキーマを中心に再利用できるようにすることが目的です。

---

## 1. `entities/schema.ts` の責務

- **サーバー側で利用する汎用スキーマのみを定義します。**
  - UI や特定のフォーム専用スキーマを追加することは禁止です。
- ファイル内にはデフォルトで下記 3 つの Zod スキーマを用意することを推奨します（ドメイン特性に応じて別構成を採用しても構いません）。
  - `XxxBaseSchema`
    - レコードの基礎構造を定義します。
  - `XxxCreateSchema`
    - `Base` を拡張し、作成時に必要な必須項目やデフォルト値を定義します。
  - `XxxUpdateSchema`
    - `Base` を拡張し、更新時に必要な項目をすべてオプショナル化した形で定義します。
- サーバーサービスや API ルートはこれらのスキーマを基準にバリデーションを実施し、フロントエンドからの入力は最終的にここへマッピングします。

必要に応じて他のスキーマを追加する場合でも、サーバー処理に直接利用するものに限定してください。

> ❗️ **重要**：フォームごとに固有の入力仕様・一時的なフィールド定義を `entities/` 配下へ追加して肥大化させないでください。ドメインに含まれるフォームでもその場でしか使わない固有の要件は必ずフォーム直下の `formEntities.ts` などに閉じ込めること。

---

## 2. `entities/form.ts` の責務

- `schema.ts` に定義された `XxxCreateSchema` / `XxxUpdateSchema` を `z.infer` した型のみをエクスポートします。
- 追加の Zod スキーマ定義は行わず、型の合成・変換も禁止です。
- 必要に応じて追加フィールド用の空型を用意し、`z.infer` した型との交差でフォーム側のプロパティを拡張できます。

  ```ts
  export type SampleCreateAdditional = {
    // 追加フィールドがあればここに記載
  };
  export type SampleCreateFields = z.infer<typeof SampleCreateSchema> & SampleCreateAdditional;
  ```
- クライアントサービスやフォームロジックでは、ここで公開される型を利用してサーバー側の正規形へ寄せたデータのやり取りを行います。

---

## 3. UI 専用スキーマの取り扱い

- フォーム固有の入力形式（複数フィールドの一時的な分割、確認用パスワードなど）は各フォームコンポーネント配下に `formEntities.ts` を作成して`FormSchema`, `FormValues`, `DefaultValues` の3つを定義。（使用箇所が限定的なため上記のようなシンプルな名称を用いる）
  - `FormSchema`: resolverに渡してバリデーションに使用する Zod スキーマ。`entities/schema.ts`をベースに拡張することを推奨。
  - `FormValues`: Zod スキーマをベースに `z.infer` で作成し、`useForm` のジェネリクスに使用。
  - `DefaultValues`: defaultValues に渡すオブジェクトを `FormValues` 型で準備。



> 同じ構造のフォームが複数必要な場合は、スキーマではなくフォームコンポーネントを再利用してください

---

## 4. 運用上のチェックポイント

1. 新しいドメインを作成する際は、まず `schema.ts` にベース・作成・更新スキーマを揃える。
2. `form.ts` には `schema.ts` の `z.infer` 型以外を追加しない。
3. フォーム固有のバリデーションが必要になったら、フォームコンポーネント直下の `formEntities.ts` に閉じ込める。
4. API やサーバーサービスでのバリデーションは常に `entities/schema.ts` を参照し、UI の都合で発生する変換はフォーム側で解決する。

この方針に従うことで、サーバー側の正規形と UI 固有の要件を明確に切り分け、ドメイン横断で再利用可能なエンティティ定義を維持できます。
