# アーキテクチャガイド

## 1. 概要

本プロジェクトはDDDの思想をベースに、フロントエンド開発に特化した拡張を行っている。

### 設計原則

- **ビジネスドメインの責務分離**: 各ドメインが独立して必要なものを持つ
- **横方向の責務侵犯を防ぐ**: ドメイン間の依存関係を明確に管理
- **すべてが何かに所属する**: グローバルな定義を極力排除し、所属を明確化

---

## 2. "3層"構造

機能の規模に応じて、3つの層に分類する。

| 級 | 説明 | 配置先 | 含められるもの                          |
|----|------|--------|----------------------------------|
| ドメイン級 | ビジネス概念として独立 | features/ | 全て（エンティティ、コンポーネント、フック、サービス、ストア等） |
| ライブラリ級 | 複数ファイルで構成される独立した機能群 | lib/\<機能名\>/ | エンティティ以外の全て                      |
| ユニット級 | ライブラリにするには過剰な単体機能 | UI: src/components/<br>ロジック: src/hooks/<br>純粋関数: src/utils/ | コンポーネント、フック、関数のみ                 |

### 判断フロー

```
Step 1: ビジネスドメインとして成立するか？
        → Yes: features/（ドメイン級）

Step 2: 複数ファイルで構成される独立した機能群か？
        → Yes: lib/<機能名>/（ライブラリ級）
        → ライブラリにするには過剰: 次へ

Step 3: 1ファイルで完結する単体機能（ユニット級）
        → UI有り（フック・関数も含んでOK）: src/components/
        → フックのみ: src/hooks/
        → 純粋関数: src/utils/
```

---

## 3. それぞれの特徴とディレクトリ配置

### 3.1 ドメイン

`src/features/` に配置する。

#### ドメイン の特徴:
- テーマごとに完結した責務を持つ一連の機能郡

#### 判断基準
- 独立したビジネス概念である
- エンティティ（DBテーブル）を持つ
- ライフサイクルを持つ（CRUD対象）

> **重要** 必ずしもDBを持つとは限らない。DB・CRUD無しのドメインも存在可能。

#### core domain と business domain の違い:
- `feature/core/`: アップストリーム（ベーステンプレート）で定義される基盤ドメイン（auth, user, wallet等）
- `feature/`: フォーク先で自由に追加するドメイン

### 3.2 ライブラリ

`src/lib` に配置する。

#### ライブラリの特徴:
- アプリケーション非依存の独立した機能群
- 複数ファイルで構成される
- コンポーネント、フック、サービス、ストア等あらゆる種類を含められる

#### 判断基準
- エンティティが必要な場合はドメインにすべき
- features/ 内のドメインに依存しない（lib同士の依存はOK）
- 別プロジェクトでも再利用できる

> Lib内での依存や外部依存はOK（npm packages, Node.js API等）

### 3.3 ユニット機能郡

#### ユニットの特徴
1ライブラリを構成するには過剰な
比較的シンプルな機能・UIパーツを **ユニット級** と称する

UIを含むもの: `src/components/`  
フックのみ: `src/hooks/`  
純粋関数: `src/utils/`  

#### components/ に置けるもの:
- UIコンポーネント（分割OK）
- 特定のドメインやライブラリに属さない汎用UI
- UI + 表示のためのロジック（フォーマット、バリデーション表示等）
- UI + 自己完結したフック（ローカル状態のみ）
- **重要** 子コンポーネント・フック・関数など切り分け推奨

> ロジックが肥大化する場合やサービス、ストアなどが必要になる場合はライブラリにする

#### hooks/ に置けるもの:

- 1ファイルで完結する単体フック
- 特定のドメインやライブラリに属さない汎用ロジック

> 対応するストア/サービスがある場合は当該のライブラリやドメイン内に所属させるべき

#### utils/ に置けるもの:

- 1ファイルで完結する純粋関数（副作用なし、React非依存）
- 特定のドメインやライブラリに属さない汎用関数

---

## 例外的なコンポーネント・フック

サービス説明など雑多な内容を記載するページの場合、
作成するコンポーネント等が上記のいずれにも当てはまらず、
所属の判断ができない場合がある。

**対象:**
- どのドメインにも属さない
- 汎用化する必要がない
- そのページでしか使わない

**対応策:**
- page.tsx と同階層に専用ディレクトリを作成
- 以降で再利用性が認められれば `src/components` に移動

**例:**
```
app/(user)/home/
  page.tsx
  _components/
    HeroSection.tsx
    CtaSection.tsx
```

### ページ構成の例:

```tsx
// app/(user)/(home)/page.tsx
import { HeroSection } from "./_components/HeroSection"
import { CtaSection } from "./_components/CtaSection"
import { EventList } from "@/features/event/components/..."
import { NewsList } from "@/features/news/components/..."

export default function HomePage() {
  return (
    <main>
      <HeroSection />       {/* ページ固有 */}
      <EventList />         {/* eventドメイン */}
      <NewsList />          {/* newsドメイン */}
      <CtaSection />        {/* ページ固有 */}
    </main>
  )
}
```

---

## 4. ドメイン間の依存関係

### UI側

- 参照先ドメインが提供するフックを使用する
- 使用側ドメインで独自にフックやクライアントサービスを作成してAPIを叩くのは禁止

### サーバー側

- サービス間の参照は自由
- 別ドメインのAPIを叩くのはオーバーヘッドが大きいので直接サービスを使用
- 循環依存は禁止（A → B → A）

---

## 5. 型・定数の配置ルール

グローバルな `src/types/` 、`src/constants/` 、`src/store/` は設置しない。
すべての型・定数、ストアは必ずドメインまたはライブラリに所属させる。
責務の定義と切り分けができていれば自然と所属がはっきりしてグローバルな定義は不要になる。

