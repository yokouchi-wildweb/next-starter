# アーキテクチャガイド

## 1. 概要

本プロジェクトはDDDの思想をベースに、フロントエンド開発に特化した拡張を行っている。

### 設計原則

- **ビジネスドメインの責務分離**: 各ドメインが独立して必要なものを持つ
- **横方向の責務侵犯を防ぐ**: ドメイン間の依存関係を明確に管理
- **すべてが何かに所属する**: グローバルな定義を極力排除し、所属を明確化

---

## 2. 3層構造

機能の規模に応じて、3つの層に分類する。

| 級 | 説明 | 配置先 |
|----|------|--------|
| ドメイン級 | ビジネス概念として独立 | features/ |
| ライブラリ級 | 複数ファイルで構成される汎用機能 | lib/\<機能名\>/ |
| ユニット級 | 1ファイルで完結する単体機能 | UI: src/components/<br>ロジック: src/hooks/ |

### 判断フロー

```
Step 1: ビジネスドメインとして成立するか？
        → Yes: features/（ドメイン級）

Step 2: lib/<機能名>/ として独立させるべきか？
        → Yes: lib/<機能名>/（ライブラリ級）
        → 過剰な場合: 次へ

Step 3: 1ファイルで完結する単体機能（ユニット級）
        → UI系: src/components/
        → ロジック系: src/hooks/
```

---

## 3. ディレクトリ配置ルール

### 3.1 features/

ビジネスドメインを配置する場所。

**core/ と business domain の違い:**
- `core/`: アップストリーム（ベーステンプレート）で定義される基盤ドメイン（auth, user, wallet等）
- `business domain`: フォーク先で自由に追加するドメイン

**features/ に置くべき条件（いずれか該当）:**
- エンティティ（DBテーブル）を持つ
- 独立したビジネス概念である
- ライフサイクルを持つ（CRUD対象）

**features/core/ の条件（いずれか該当）:**
- エンティティを持つ
- 他のドメインのサービス/エンティティに依存する
- アプリ固有の型（SessionUser等）に依存する
- アプリのルーティング構造に依存するUIを含む

### 3.2 lib/

アプリケーション非依存のユーティリティを配置する場所。

**lib/ の条件（すべて満たす）:**
- features/ 内の何にも依存しない
- 外部依存のみ（npm packages, Node.js API等）
- 設定を注入すれば別プロジェクトで動く

**lib/ vs features/core/ の判断フロー:**
```
Q1. features/ 内の何かに依存しているか？
    → Yes: features/core/
    → No: 次へ

Q2. 別プロジェクトにコピーしてそのまま動くか？
    → Yes: lib/
    → No: features/core/
```

### 3.3 components/

UIが主となる汎用コンポーネントを配置する場所。

**components/ に置けるもの:**
- 純粋なUIコンポーネント
- UI + 表示のためのロジック（フォーマット、バリデーション表示等）
- UI + 自己完結したフック（ローカル状態のみ、外部API呼び出しなし）

**components/ vs lib/ の判断:**
```
Q1. UIを持つか？
    → No: lib/
    → Yes: 次へ

Q2. 外部通信（API、DB）を行うか？
    → Yes: lib/
    → No: 次へ

Q3. UIなしで意味があるか？（サービスや他の場所で使えるか？）
    → Yes: lib/
    → No: components/
```

### 3.4 hooks/

1ファイルで完結する独立した汎用フックを配置する場所。

**src/hooks/ に置けるもの:**
- 1ファイルで完結する
- 特定のドメインに依存しない
- 特定のlib/\<機能名\>/に属さない

**対応するストア/サービスがある場合:**
- lib/\<機能名\>/ に一緒に置く
- 例: lib/toast/useToast.ts

### 3.5 utils/

純粋関数の集約場所。例外的にグローバル配置を許容する。

**src/utils/ に置いてよいもの:**
- 純粋関数である（副作用なし）
- 特定のドメインに依存しない
- 特定のlib/\<機能名\>/に属さない
- 1ファイルで完結する

**src/utils/ に置いてはいけないもの:**
- 特定ドメインのロジック → features/\<domain\>/utils/
- 特定ライブラリに関連 → lib/\<機能名\>/utils.ts
- 複数ファイルで構成 → lib/\<機能名\>/

### 3.6 app/_components/

ページ固有のコンポーネントを配置する場所。

**対象:**
- どのドメインにも属さない
- 汎用化する必要がない
- そのページでしか使わない

**例:**
```
app/(user)/(home)/
  page.tsx
  _components/
    HeroSection.tsx
    CtaSection.tsx
```

**ページ構成の例:**
```tsx
// app/(user)/(home)/page.tsx
import { HeroSection } from "./_components/HeroSection"
import { CtaSection } from "./_components/CtaSection"
import { EventList } from "@/features/event/components/..."
import { NewsList } from "@/features/news/components/..."

export default function HomePage() {
  return (
    <main>
      <HeroSection />       {/* ページ固有 */}
      <EventList />         {/* eventドメイン */}
      <NewsList />          {/* newsドメイン */}
      <CtaSection />        {/* ページ固有 */}
    </main>
  )
}
```

---

## 4. ドメイン間の依存関係

### UI側

- 参照先ドメインが提供するフックを使用する
- 使用側ドメインで独自にフックを作成してAPIを叩かない

### サーバー側

- サービス間の参照は自由
- 循環依存は禁止（A → B → A）
- 具体的な制限定義は設けない（ガイドライン）

---

## 5. 型・定数の配置ルール

グローバルな src/types/ や src/constants/ は設置しない。すべての型・定数は必ずドメインまたはライブラリに所属させる。

**配置先:**
```
ビジネスドメイン固有 → features/<domain>/types/, constants/
アプリ基盤に関わる   → features/core/<domain>/
汎用的・再利用可能   → lib/<category>/types.ts, constants.ts
```

---

## 6. 判断フローまとめ

新機能を作成する際の判断フロー:

```
Step 1: features/ に置くべきか？

  以下のいずれかに該当 → features/
    - エンティティ（DBテーブル）を持つ
    - 独立したビジネス概念である
    - ライフサイクルを持つ（CRUD対象）

  該当しない → lib/ または components/ または hooks/ または utils/

Step 1-2: core/ か business domain か？

  アップストリーム（ベーステンプレート）で定義 → core/
  フォーク先で追加 → business domain

Step 2: lib/<機能名>/ として独立させるべきか？

  複数ファイルで構成される → lib/<機能名>/
  1ファイルで完結 → 次へ

Step 3: ユニット級の配置先

  Q1. UIを持つか？
      → Yes: src/components/
      → No: 次へ

  Q2. 純粋関数か？（React非依存、副作用なし）
      → Yes: src/utils/
      → No: src/hooks/
```
